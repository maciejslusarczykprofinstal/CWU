<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>STRATY CWU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
    h1{margin-bottom:8px}
    fieldset{border:1px solid #ddd;border-radius:8px;margin:16px 0;padding:12px}
    label{display:flex;gap:8px;align-items:center;margin:6px 0}
    input,select{padding:6px 8px;border:1px solid #ccc;border-radius:6px;flex:1}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid #444;background:#fff;cursor:pointer}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin-top:16px}
    code{background:#f6f8fa;padding:2px 6px;border-radius:6px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:8px;text-align:right}
    th{text-align:left;background:#f6f8fa}
  </style>
</head>
<body>
  <h1>STRATY CWU</h1>
  <p>Ping: <a href="/healthz">/healthz</a></p>

  <form method="post" action="/app">
    <fieldset>
      <legend>Rurociąg cyrkulacyjny</legend>
      <div class="grid">
        <label>L [m] <input type="number" step="0.01" name="L_m" value="{{ form.L_m }}"></label>
        <label>d<sub>zew</sub> [mm] <input type="number" step="0.01" name="d_out_mm" value="{{ form.d_out_mm }}"></label>
        <label>Izolacja [mm] <input type="number" step="0.01" name="insulation_mm" value="{{ form.insulation_mm }}"></label>
        <label>λ izolacji [W/mK] <input type="number" step="0.0001" name="lambda_ins" value="{{ form.lambda_ins }}"></label>
        <label>h<sub>zew</sub> [W/m²K] <input type="number" step="0.01" name="h_ext" value="{{ form.h_ext }}"></label>
        <label>T<sub>woda</sub> [°C] <input type="number" step="0.1" name="T_hot" value="{{ form.T_hot }}"></label>
        <label>T<sub>otoczenia</sub> [°C] <input type="number" step="0.1" name="T_amb" value="{{ form.T_amb }}"></label>
        <label>DN (zastąpi d<sub>zew</sub>)
          <select name="dn_key">
            <option value="">— bez zmiany —</option>
            {% for key, outer in dn_map.items() %}
              <option value="{{ key }}" {% if form.d_out_mm == outer %}selected{% endif %}>
                {{ key }} ({{ outer }} mm)
              </option>
            {% endfor %}
          </select>
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Zasobnik</legend>
      <div class="grid">
        <label>U·A [W/K] <input type="number" step="0.01" name="UA_tank" value="{{ form.UA_tank }}"></label>
        <label>T<sub>zas.</sub> [°C] <input type="number" step="0.1" name="T_tank" value="{{ form.T_tank }}"></label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Bilans i koszty</legend>
      <div class="grid">
        <label>h/dzień <input type="number" step="0.01" name="hours_per_day" value="{{ form.hours_per_day }}"></label>
        <label>d/rok <input type="number" step="1" name="days_per_year" value="{{ form.days_per_year }}"></label>
        <label>cena [zł/GJ] <input type="number" step="0.01" name="price_per_GJ" value="{{ form.price_per_GJ }}"></label>
      </div>
    </fieldset>

    <button class="btn" type="submit">Oblicz</button>
  </form>

  {% if error %}
    <div class="card" style="border-color:#f33">
      <strong>Błąd obliczeń</strong>
      <pre style="white-space:pre-wrap">{{ error }}</pre>
    </div>
  {% endif %}

  {% if result %}
    <div class="card">
      <strong>Wyniki</strong>
      <table>
        <tr><th>gęstość strat q [W/m]</th><td>{{ '%.3f'|format(result.loop_q_wpm) if result.loop_q_wpm is not none else '-' }}</td></tr>
        <tr><th>straty pętli Q̇ [kW]</th><td>{{ '%.3f'|format(result.loop_Qdot_kW) if result.loop_Qdot_kW is not none else '-' }}</td></tr>
        <tr><th>straty zasobnika [W]</th><td>{{ '%.1f'|format(result.tank_loss_W) }}</td></tr>
        <tr><th>moc całkowita [kW]</th><td>{{ '%.3f'|format(result.total_kW) }}</td></tr>
        <tr><th>energia roczna [kWh]</th><td>{{ '%.0f'|format(result.E_kWh_year) }}</td></tr>
        <tr><th>energia roczna [GJ]</th><td>{{ '%.2f'|format(result.E_GJ_year) }}</td></tr>
        <tr><th>koszt roczny [zł]</th><td>{{ '%.2f'|format(result.cost_year) }}</td></tr>
      </table>
    </div>
  {% endif %}
</body>
</html>
